name: Test Matrix

on: [push, pull_request]

jobs:
  test-distros:
    # å…³é”®ç‚¹ 1: åœ¨ Ubuntu å®¿ä¸»æœºä¸Šè¿è¡Œ Jobï¼Œè€Œä¸æ˜¯ç›´æ¥åœ¨å®¹å™¨é‡Œè·‘
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        container:
          - 'debian:11'
          - 'debian:12'
          - 'ubuntu:22.04'
          - 'alpine:latest'
          - 'almalinux:9'
          - 'rockylinux:9'
          - 'centos:7'                        # è¿™é‡Œçš„ CentOS 7 ç°åœ¨å¯ä»¥è·‘äº†ï¼
          - 'quay.io/centos/centos:stream9'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Test in Container
        run: |
          echo "ğŸš€ Testing on image: ${{ matrix.container }}"
          chmod +x init.sh

          # å¯åŠ¨å®¹å™¨å¹¶è¿è¡Œæ‰€æœ‰é€»è¾‘
          docker run --rm --privileged -v $(pwd):/mnt -w /mnt ${{ matrix.container }} /bin/sh -c '
            
            # ============================================
            # 1. é’ˆå¯¹ CentOS 7 çš„â€œå¼ºæ•ˆèµ·æ­»å›ç”Ÿâ€è¡¥ä¸
            # ============================================
            if [ -f /etc/redhat-release ] && grep -q "CentOS Linux 7" /etc/redhat-release; then
              echo "ğŸ’€ Detected CentOS 7 (EOL). Fixing repositories to Vault..."
              
              # 1. æ³¨é‡Šæ‰å¤±æ•ˆçš„ mirrorlist
              sed -i "s/^mirrorlist/#mirrorlist/g" /etc/yum.repos.d/CentOS-*.repo
              
              # 2. å¯ç”¨ baseurl å¹¶æŒ‡å‘ vault.centos.org (å¤„ç†å¸¦#å’Œä¸å¸¦#çš„æƒ…å†µ)
              sed -i "s|^#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g" /etc/yum.repos.d/CentOS-*.repo
              sed -i "s|^baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g" /etc/yum.repos.d/CentOS-*.repo
              
              # 3. æ¸…ç†ç¼“å­˜ï¼Œé˜²æ­¢æ®‹ç•™
              yum clean all
              rm -rf /var/cache/yum
            fi

            # ============================================
            # 2. ç¯å¢ƒè¡¥å…¨ (å®‰è£… sudo, sshd, ç”Ÿæˆ key)
            # ============================================
            echo "ğŸ“¦ Installing dependencies..."
            
            # --- Debian / Ubuntu ---
            if [ -f /etc/debian_version ]; then
              apt-get update -y && apt-get install -y curl sudo openssh-server
              ssh-keygen -A
              mkdir -p /run/sshd
            fi

            # --- Alpine ---
            if [ -f /etc/alpine-release ]; then
              apk add --no-cache curl sudo openssh-server bash
              ssh-keygen -A
            fi

            # --- RHEL / CentOS / Alma / Rocky ---
            if [ -f /etc/redhat-release ]; then
              # AlmaLinux 9 è§£å†³ curl-minimal å†²çª
              if command -v dnf >/dev/null; then
                dnf install -y --allowerasing curl sudo openssh-server
              else
                # å¯¹äº CentOS 7ï¼Œè¿™ä¸€æ­¥ç°åœ¨åº”è¯¥èƒ½æˆåŠŸäº†
                yum install -y curl sudo openssh-server
              fi
              
              # ç”Ÿæˆä¸»æœºå¯†é’¥ (å…³é”®ä¿®å¤)
              ssh-keygen -A
              mkdir -p /run/sshd
            fi

            # ============================================
            # 3. è¿è¡Œä½ çš„è„šæœ¬
            # ============================================
            echo "ğŸš€ Running init script..."
            ./init.sh --user=root --port=2222 --key-raw="ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPQQDejyTCPJO3Jyw5UX9jmojb/zjgcqVuRO28fmpWU5" --no-update --bbr --delay-restart --yes --strict
            
            # ============================================
            # 4. éªŒè¯ç»“æœ
            # ============================================
            if grep -q "BEGIN SERVER-INIT MANAGED BLOCK" /etc/ssh/sshd_config; then
               echo "âœ… SUCCESS: Config block injected."
            else
               echo "âŒ FAIL: Config block missing."
               exit 1
            fi
          '
